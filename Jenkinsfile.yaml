pipeline:
  agent:
    docker:
      image: 'node:lts-bullseye-slim'
      args: '-p 3000:3000'
  tools:
    nodejs: "NodeJS"
  branch: "main"
  stages:
    - stage: "Log Jenkins Node and Git versions"
      steps:
        - sh "node -v" 

    - stage: "Building"
      steps:
        - sh "npm -g config set user root"
        - sh "npm install"
        - sh "npm install -g mocha"
        - sh "npm start & sleep 1"
        - sh "echo \$! > .pidfile"
    - stage: "Running tests"
      steps:
        - sh "npm test"
    - stage: "Deliver"
      steps:
        - sh 'set -x'
        - sh 'kill $(cat .pidfile)'
